<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Calc</title>
    </head>
    <style>
        .column {
            float: left;
        }

        .column.left {
            text-align: left;
            width: 30%;
            margin-top: 3%;
        }

        .column.middle1 {
            text-align: left;
            width: 25%;
            margin-top: 3%;
        }

        .column.middle2 {
            text-align: left;
            width: 25%;
            margin-top: 3%;
        }

        .column.right {
            text-align: left;
            width: 20%;
            margin-top: 3%;
        }
        .params {
            background: #efdecd;
        }
        .header {
            background-color: darkgoldenrod;
            text-align: center;
            padding: 1%;
            color: beige;
            font-size: 200%;
        }
    </style>
    <body>
        <div class="header">Swap Simulation</div>
        <!-- Left: params. -->
        <div class="column left">
            <form action="" oninput="CalcRpp();CalcTogether();CalcDiff()">
                <table>
                    <tr>
                        <td>oracle price 1</td>
                        <td>=</td>
                        <td class="params" id="op1" contenteditable>1</td>
                    </tr>
                    <tr>
                        <td>oracle price 2</td>
                        <td>=</td>
                        <td class="params" id="op2" contenteditable>1</td>
                    </tr>
                    <tr>
                        <td>liability 1</td>
                        <td>=</td>
                        <td class="params" id="lia1" contenteditable>10000</td>
                    </tr>
                    <tr>
                        <td>liability 2</td>
                        <td>=</td>
                        <td class="params" id="lia2" contenteditable>10000</td>
                    </tr>
                    <tr>
                        <td>n</td>
                        <td>=</td>
                        <td class="params" id="n" contenteditable>1</td>
                    </tr>
                    <tr>
                        <td>swap 1 amount(token 1)</td>
                        <td>=</td>
                        <td class="params" id="amount1" contenteditable>0</td>
                    </tr>
                    <tr>
                        <td>swap 2 amount(token 1)</td>
                        <td>=</td>
                        <td class="params" id="amount2" contenteditable>0</td>
                    </tr>
                    <tr>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>decimals(of the middle column)</td>
                        <td>=</td>
                        <td class="params" id="decimals" contenteditable>3</td>
                    </tr>
                </table>
            </form>
        </div>
        <div class="column middle1">
            <div>Swap 1</div>
            <br />
            <table>
                <tr>
                    <td>cov 1</td>
                    <td>=</td>
                    <td class="variable" id="cov1"></td>
                </tr>
                <tr>
                    <td>cov 2</td>
                    <td>=</td>
                    <td class="variable" id="cov2"></td>
                </tr>
                <tr>
                    <td>rop</td>
                    <td>=</td>
                    <td class="variable" id="rop"></td>
                </tr>
                <tr>
                    <td>rcov</td>
                    <td>=</td>
                    <td class="variable" id="rcov"></td>
                </tr>
                <tr>
                    <td>rpp</td>
                    <td>=</td>
                    <td class="variable" id="rpp"></td>
                </tr>
                <tr>
                    <td>estimate out</td>
                    <td>=</td>
                    <td class="variable" id="estimate-out"></td>
                </tr>
                <tr>
                    <td>price shift</td>
                    <td>=</td>
                    <td class="variable" id="price-shift"></td>
                </tr>
            </table>
            <hr />
            <div>Swap 2</div>
            <br />
            <table>
                <tr>
                    <td>cov 1</td>
                    <td>=</td>
                    <td class="variable" id="cov1_2"></td>
                </tr>
                <tr>
                    <td>cov 2</td>
                    <td>=</td>
                    <td class="variable" id="cov2_2"></td>
                </tr>
                <tr>
                    <td>rop</td>
                    <td>=</td>
                    <td class="variable" id="rop_2"></td>
                </tr>
                <tr>
                    <td>rcov</td>
                    <td>=</td>
                    <td class="variable" id="rcov_2"></td>
                </tr>
                <tr>
                    <td>rpp</td>
                    <td>=</td>
                    <td class="variable" id="rpp_2"></td>
                </tr>
                <tr>
                    <td>estimate out</td>
                    <td>=</td>
                    <td class="variable" id="estimate-out_2"></td>
                </tr>
                <tr>
                    <td>price shift</td>
                    <td>=</td>
                    <td class="variable" id="price-shift_2"></td>
                </tr>
            </table>
            <hr />
            <div>Together</div>
            <br />
            <table>
                <tr>
                    <td>out together</td>
                    <td>=</td>
                    <td class="variable" id="estimate-out_together"></td>
                </tr>
            </table>
        </div>
        <div class="column middle1">
            <div>Two swaps together</div>
            <br />
            <table>
                <tr>
                    <td>cov 1</td>
                    <td>=</td>
                    <td class="variable" id="cov1_to"></td>
                </tr>
                <tr>
                    <td>cov 2</td>
                    <td>=</td>
                    <td class="variable" id="cov2_to"></td>
                </tr>
                <tr>
                    <td>rop</td>
                    <td>=</td>
                    <td class="variable" id="rop_to"></td>
                </tr>
                <tr>
                    <td>rcov</td>
                    <td>=</td>
                    <td class="variable" id="rcov_to"></td>
                </tr>
                <tr>
                    <td>rpp</td>
                    <td>=</td>
                    <td class="variable" id="rpp_to"></td>
                </tr>
                <tr>
                    <td>estimate out</td>
                    <td>=</td>
                    <td class="variable" id="estimate-out_to"></td>
                </tr>
                <tr>
                    <td>price shift</td>
                    <td>=</td>
                    <td class="variable" id="price-shift_to"></td>
                </tr>
                <tr>
                    <td>-</td>
                </tr>
                <tr>
                    <td>diff</td>
                    <td>=</td>
                    <td class="variable" id="estimate-out_diff"></td>
                </tr>
            </table>
        </div>
        <div class="column right">
            <div>
                <div>
                    <p>Swap "amount" token 1 to token 2.</p>
                    <p>Will get "estimate out" token 2.</p>
                    <p>Pair token price rate after swap is "rpp".</p>
                </div>
                <hr />
                <div>cov i = asset i / liability i</div>
                <hr />
                <div>rop = op 1 / op 2</div>
                <div>rcov = cov 1 / cov 2</div>
                <hr />
                <div>rpp: The token price of the pair. Decide the amount user get and the final price of the pair.</div>
                <div>-</div>
                <div>rpp = rop * G(rcov, n)</div>
                <div>G(rcov, n) = (1 / rcov - 1) / n + 1</div>
            </div>
        </div>
        <script>
            function Grcov(rcov, n) {
                return (1 / rcov - 1) / n + 1;
                // return rcov ** (-1 / n);
            }

            function CalcTogether() {
                // Read.
                let lia1 = parseFloat(document.getElementById("lia1").textContent);
                let lia2 = parseFloat(document.getElementById("lia2").textContent);
                let ass1 = parseFloat(document.getElementById("lia1").textContent);
                let ass2 = parseFloat(document.getElementById("lia2").textContent);

                let op1 = parseFloat(document.getElementById("op1").textContent);
                let op2 = parseFloat(document.getElementById("op2").textContent);

                let n = parseFloat(document.getElementById("n").textContent);

                let amount1 = parseFloat(document.getElementById("amount1").textContent);
                let amount2 = parseFloat(document.getElementById("amount2").textContent);

                let decimals = parseInt(document.getElementById("decimals").textContent);

                let amount = amount1 + amount2;
                // Calc.
                let cov1 = ass1 / lia1;
                let cov2 = ass2 / lia2;

                let rop = op1 / op2;
                let rcov = cov1 / cov2;

                let _a = (ass1 + amount) * ass2 * rcov + (amount * ass1 * rop) / n;
                let _b = ass1 * ass2 - amount * ass1 * rop * (1 - 1 / n);
                rcov = _a / _b;

                let rpp = rop * Grcov(rcov, n);
                let estimate_out = amount * rpp;

                ass1 += amount;
                ass2 -= estimate_out;
                cov1 = ass1 / lia1;
                cov2 = ass2 / lia2;
                let shift = 1 - estimate_out / rop / amount;

                document.getElementById("cov1_to").innerHTML = cov1.toFixed(decimals);
                document.getElementById("cov2_to").innerHTML = cov2.toFixed(decimals);
                document.getElementById("rop_to").innerHTML = rop.toFixed(decimals);
                document.getElementById("rcov_to").innerHTML = rcov.toFixed(decimals);
                document.getElementById("rpp_to").innerHTML = rpp.toFixed(decimals);
                document.getElementById("estimate-out_to").innerHTML = estimate_out.toFixed(decimals);
                document.getElementById("price-shift_to").innerHTML = String((shift * 100).toFixed(decimals)) + "%";
            }

            function CalcRpp() {
                // Read.
                let lia1 = parseFloat(document.getElementById("lia1").textContent);
                let lia2 = parseFloat(document.getElementById("lia2").textContent);
                let ass1 = parseFloat(document.getElementById("lia1").textContent);
                let ass2 = parseFloat(document.getElementById("lia2").textContent);

                let op1 = parseFloat(document.getElementById("op1").textContent);
                let op2 = parseFloat(document.getElementById("op2").textContent);

                let n = parseFloat(document.getElementById("n").textContent);

                let amount1 = parseFloat(document.getElementById("amount1").textContent);
                let amount2 = parseFloat(document.getElementById("amount2").textContent);

                let decimals = parseInt(document.getElementById("decimals").textContent);

                // Calc.
                let cov1 = ass1 / lia1;
                let cov2 = ass2 / lia2;

                let rop = op1 / op2;
                let rcov = cov1 / cov2;

                let _a = (ass1 + amount1) * ass2 * rcov + (amount1 * ass1 * rop) / n;
                let _b = ass1 * ass2 - amount1 * ass1 * rop * (1 - 1 / n);
                rcov = _a / _b;

                let rpp = rop * Grcov(rcov, n);
                let estimate_out = amount1 * rpp;

                ass1 += amount1;
                ass2 -= estimate_out;
                cov1 = ass1 / lia1;
                cov2 = ass2 / lia2;
                let shift = 1 - estimate_out / rop / amount1;

                document.getElementById("cov1").innerHTML = cov1.toFixed(decimals);
                document.getElementById("cov2").innerHTML = cov2.toFixed(decimals);
                document.getElementById("rop").innerHTML = rop.toFixed(decimals);
                document.getElementById("rcov").innerHTML = rcov.toFixed(decimals);
                document.getElementById("rpp").innerHTML = rpp.toFixed(decimals);
                document.getElementById("estimate-out").innerHTML = estimate_out.toFixed(decimals);
                document.getElementById("price-shift").innerHTML = String((shift * 100).toFixed(decimals)) + "%";

                _a = (ass1 + amount2) * ass2 * rcov + (amount2 * ass1 * rop) / n;
                _b = ass1 * ass2 - amount2 * ass1 * rop * (1 - 1 / n);
                rcov = _a / _b;
                rpp = rop * Grcov(rcov, n);
                let estimate_out_2 = amount2 * rpp;
                ass1 += amount2;
                ass2 -= estimate_out_2;
                cov1 = ass1 / lia1;
                cov2 = ass2 / lia2;
                shift = 1 - estimate_out_2 / rop / amount2;

                document.getElementById("cov1_2").innerHTML = cov1.toFixed(decimals);
                document.getElementById("cov2_2").innerHTML = cov2.toFixed(decimals);
                document.getElementById("rop_2").innerHTML = rop.toFixed(decimals);
                document.getElementById("rcov_2").innerHTML = rcov.toFixed(decimals);
                document.getElementById("rpp_2").innerHTML = rpp.toFixed(decimals);
                document.getElementById("estimate-out_2").innerHTML = estimate_out_2.toFixed(decimals);
                document.getElementById("price-shift_2").innerHTML = String((shift * 100).toFixed(decimals)) + "%";

                let out_together = estimate_out_2 + estimate_out;
                document.getElementById("estimate-out_together").innerHTML = out_together.toFixed(decimals);
            }

            function CalcDiff() {
                let sep = parseFloat(document.getElementById("estimate-out_together").textContent);
                let tog = parseFloat(document.getElementById("estimate-out_to").textContent);
                let decimals = parseInt(document.getElementById("decimals").textContent);

                let diff = String(((sep / tog - 1) * 100).toFixed(decimals)) + "%";
                document.getElementById("estimate-out_diff").innerHTML = diff;
            }

            CalcRpp();
            CalcTogether();
            CalcDiff();
        </script>
    </body>
</html>
